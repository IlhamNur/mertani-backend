<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mertani Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background: #f8f9fa;
      }
      .card {
        border-radius: 1rem;
      }
      h1,
      h3 {
        color: #333;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-5 text-center">
      <h1 class="mb-4">Mertani IoT Management</h1>
      <p class="lead">Kelola Device dan Sensor dengan mudah.</p>
      <div class="mt-5">
        <a href="devices.html" class="btn btn-primary btn-lg me-3"
          >Kelola Device</a
        >
        <a href="sensors.html" class="btn btn-success btn-lg">Kelola Sensor</a>
      </div>
      <div id="stats" class="row justify-content-center my-5">
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body text-center">
              <h5>Total Devices</h5>
              <h2 id="totalDevices">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body text-center">
              <h5>Total Sensors</h5>
              <h2 id="totalSensors">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body text-center">
              <h5>Active Devices</h5>
              <h2 id="activeDevices">0</h2>
            </div>
          </div>
        </div>
      </div>
      <div class="container my-5">
        <h3 class="mb-4 text-center">Sensor Visualization</h3>
        <div class="row">
          <div class="col-md-6">
            <div class="card shadow-sm mb-4">
              <div class="card-body">
                <h5 class="card-title text-center">Sensor Count by Type</h5>
                <canvas id="sensorTypeChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card shadow-sm mb-4">
              <div class="card-body">
                <h5 class="card-title text-center">Sensor Count by Device</h5>
                <canvas id="sensorDeviceChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card shadow-sm mb-5">
        <div class="card-body">
          <h5 class="card-title text-center">Sensor Value Over Time</h5>
          <div class="d-flex mb-3">
            <label class="me-2">Pilih Sensor Type:</label>
            <select id="sensorTypeSelect" class="form-select w-auto">
              <option value="">Semua</option>
            </select>
          </div>
          <canvas id="sensorTimeChart" height="120"></canvas>
        </div>
      </div>
      <div class="card shadow-sm mb-5">
        <div class="card-body">
          <h5 class="card-title text-center">Data Delivery Logs</h5>
          <button
            class="btn btn-outline-primary btn-sm float-end"
            onclick="loadDeliveryLogs();loadDeliveryStatusChart();"
          >
            Refresh Logs
          </button>
          <table class="table table-striped" id="logTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Device ID</th>
                <th>Status</th>
                <th>Retry</th>
                <th>Last Attempt</th>
                <th>Error</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="mt-4">
        <h5 class="text-center mb-3">Delivery Status Overview</h5>
        <canvas id="deliveryStatusChart"></canvas>
      </div>
    </div>
    <script>
      async function loadStats() {
        const [devRes, senRes] = await Promise.all([
          fetch("http://localhost:8080/devices"),
          fetch("http://localhost:8082/sensors"),
        ]);

        const devices = await devRes.json();
        const sensors = await senRes.json();

        document.getElementById("totalDevices").innerText = devices.length;
        document.getElementById("totalSensors").innerText = sensors.length;
        document.getElementById("activeDevices").innerText = devices.filter(
          (d) => d.status
        ).length;
      }
    </script>
    <script>
      let sensorTypeChart;
      let sensorDeviceChart;

      async function loadCharts() {
        const sensorsRes = await fetch("http://localhost:8082/sensors");
        const sensors = await sensorsRes.json();

        // --- Chart 1: Sensor by Type ---
        const typeCounts = {};
        sensors.forEach((s) => {
          typeCounts[s.type] = (typeCounts[s.type] || 0) + 1;
        });

        const ctx1 = document
          .getElementById("sensorTypeChart")
          .getContext("2d");

        if (sensorTypeChart) sensorTypeChart.destroy();

        sensorTypeChart = new Chart(ctx1, {
          type: "pie",
          data: {
            labels: Object.keys(typeCounts),
            datasets: [
              {
                data: Object.values(typeCounts),
                backgroundColor: [
                  "#007bff",
                  "#28a745",
                  "#ffc107",
                  "#dc3545",
                  "#6610f2",
                ],
              },
            ],
          },
          options: {
            plugins: { legend: { position: "bottom" } },
          },
        });

        // --- Chart 2: Sensor by Device ---
        const deviceCounts = {};
        sensors.forEach((s) => {
          deviceCounts[s.deviceId] = (deviceCounts[s.deviceId] || 0) + 1;
        });

        const ctx2 = document
          .getElementById("sensorDeviceChart")
          .getContext("2d");

        if (sensorDeviceChart) sensorDeviceChart.destroy();

        sensorDeviceChart = new Chart(ctx2, {
          type: "bar",
          data: {
            labels: Object.keys(deviceCounts).map((id) => `Device ${id}`),
            datasets: [
              {
                label: "Sensor Count",
                data: Object.values(deviceCounts),
                backgroundColor: "#17a2b8",
              },
            ],
          },
          options: {
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } },
          },
        });
      }
    </script>
    <script>
      let sensorTimeChart;

      async function loadSensorTimeChart() {
        const sensorsRes = await fetch("http://localhost:8082/sensors");
        const sensors = await sensorsRes.json();

        const types = [...new Set(sensors.map((s) => s.type))];
        const select = document.getElementById("sensorTypeSelect");

        if (select.options.length === 1) {
          types.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            select.appendChild(opt);
          });
        }

        const selectedType = select.value;
        const filtered = selectedType
          ? sensors.filter((s) => s.type === selectedType)
          : sensors;

        const recent = filtered.slice(-10);

        const labels = recent.map((s, i) => `T-${recent.length - i}`);
        const values = recent.map((s) => s.value);

        const ctx = document.getElementById("sensorTimeChart").getContext("2d");

        if (sensorTimeChart) {
          sensorTimeChart.data.labels = labels;
          sensorTimeChart.data.datasets[0].data = values;
          sensorTimeChart.data.datasets[0].label = `Sensor Value (${
            selectedType || "All"
          })`;
          sensorTimeChart.update();
        } else {
          const colorMap = {
            temperature: "#ff5733",
            humidity: "#3498db",
            pressure: "#27ae60",
            default: "#007bff",
          };
          const color = colorMap[selectedType] || colorMap.default;

          sensorTimeChart = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: `Sensor Value (${selectedType || "All"})`,
                  data: values,
                  fill: false,
                  borderColor: color,
                  tension: 0.3,
                },
              ],
            },
            options: {
              scales: { y: { beginAtZero: true } },
              plugins: { legend: { display: true, position: "bottom" } },
            },
          });
        }
      }

      document
        .getElementById("sensorTypeSelect")
        .addEventListener("change", loadSensorTimeChart);
    </script>
    <script>
      async function loadDeliveryLogs() {
        const res = await fetch("http://localhost:8080/delivery-logs");
        const logs = await res.json();
        const tableBody = document.querySelector("#logTable tbody");
        tableBody.innerHTML = "";

        logs.forEach((log) => {
          const row = `
            <tr>
              <td>${log.id}</td>
              <td>${log.device_id ?? "-"}</td>
              <td>${statusBadge(log.status)}</td>
              <td>${log.retry_count}/${log.max_retries}</td>
              <td>${
                log.last_attempt_at
                  ? new Date(log.last_attempt_at).toLocaleString()
                  : "-"
              }</td>
              <td>${log.last_error ? log.last_error.slice(0, 50) : "-"}</td>
            </tr>`;
          tableBody.insertAdjacentHTML("beforeend", row);
        });
      }

      function statusBadge(status) {
        const color =
          {
            sent: "success",
            pending: "secondary",
            failed: "warning",
            permanent_failed: "danger",
          }[status] || "secondary";

        return `<span class="badge bg-${color}">${status}</span>`;
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        await loadStats();
        await loadCharts();
        await loadSensorTimeChart();
        await loadDeliveryLogs();
        await loadDeliveryStatusChart();

        setInterval(async () => {
          await loadStats();
          await loadCharts();
          await loadSensorTimeChart();
          await loadDeliveryLogs();
          await loadDeliveryStatusChart();
        }, 15000);
      });
    </script>
    <script>
      let deliveryChart;

      async function loadDeliveryStatusChart() {
        const res = await fetch("http://localhost:8080/delivery-logs");
        const logs = await res.json();

        const counts = { sent: 0, failed: 0, permanent_failed: 0, pending: 0 };
        logs.forEach((l) => (counts[l.status] = (counts[l.status] || 0) + 1));

        const ctx = document
          .getElementById("deliveryStatusChart")
          .getContext("2d");

        if (deliveryChart) {
          deliveryChart.data.datasets[0].data = Object.values(counts);
          deliveryChart.update();
        } else {
          deliveryChart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: Object.keys(counts),
              datasets: [
                {
                  data: Object.values(counts),
                  backgroundColor: ["#28a745", "#ffc107", "#dc3545", "#6c757d"],
                },
              ],
            },
            options: {
              plugins: { legend: { position: "bottom" } },
            },
          });
        }
      }
    </script>
  </body>
</html>
